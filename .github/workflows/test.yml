name: Build qBittorrent with libtorrent

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Install dependencies
      run: |
        choco install -y cmake ninja jom
        echo "C:\\Program Files\\CMake\\bin" >> $env:GITHUB_PATH

    - name: Install vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        echo "C:\\vcpkg" >> $env:GITHUB_PATH

    - name: Install dependencies via vcpkg
      run: |
        C:\vcpkg\vcpkg.exe install zlib openssl qtbase qtsvg qttools --triplet x64-windows-static

    - name: Download and extract Boost
      run: |
        Invoke-WebRequest -Uri "https://archives.boost.io/release/1.86.0/source/boost_1_86_0.zip" -OutFile boost.zip
        Expand-Archive boost.zip -DestinationPath C:\boost

    - name: Checkout and build libtorrent
      run: |
        git clone --branch RC_1_2 https://github.com/arvidn/libtorrent.git C:\libtorrent
        cd C:\libtorrent
        cmake -B build -G "Ninja" -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake -DBOOST_ROOT=C:\boost -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Checkout and build qBittorrent
      run: |
        git clone --branch v5.0.x https://github.com/qbittorrent/qBittorrent.git C:\qbittorrent
        cd C:\qbittorrent
        cmake -B build -G "Ninja" -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake -DBOOST_ROOT=C:\boost -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: qBittorrent
        path: C:\qbittorrent\build\src\app\release\qbittorrent.exe
