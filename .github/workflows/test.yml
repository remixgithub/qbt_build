name: test.yml

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          git
          make
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-boost
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-qt6
          mingw-w64-x86_64-qt5
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-zlib

    - name: Install libtorrent
      shell: msys2 {0}
      run: |
        cd /c
        git clone --recursive --depth 1 --branch v1.2.20 https://github.com/arvidn/libtorrent.git
        cd libtorrent
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/c/libtorrent-install ..
        cmake --build . --config Release --parallel
        cmake --install .

    - name: Build qBittorrent 5.0.3
      shell: msys2 {0}
      run: |
        cd /c
        git clone --recursive --depth 1 --branch release-5.0.3 https://github.com/qbittorrent/qBittorrent.git
        cd qBittorrent
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="/c/libtorrent-install;/mingw64" -DQT6=ON -DOPENSSL_ROOT_DIR="/mingw64" ..
        cmake --build . --config Release --parallel
        cp ./release/qbittorrent.exe /c/qbittorrent_503.exe

    - name: Build qBittorrent 4.4.5
      shell: msys2 {0}
      run: |
        cd /c
        git clone --recursive --depth 1 --branch release-4.4.5 https://github.com/qbittorrent/qBittorrent.git qbittorrent_445
        cd qbittorrent_445
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="/c/libtorrent-install;/mingw64" -DQT6=OFF -DOPENSSL_ROOT_DIR="/mingw64" ..
        cmake --build . --config Release --parallel
        cp ./release/qbittorrent.exe /c/qbittorrent_445.exe

    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: qbittorrent-builds
        path: |
          /c/qbittorrent_503.exe
          /c/qbittorrent_445.exe
