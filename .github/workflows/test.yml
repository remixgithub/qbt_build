name: test

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: vcpkg
      id: vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        echo "VCPKG_ROOT=$env:GITHUB_WORKSPACE\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        $env:VCPKG_DEFAULT_TRIPLET="x64-windows-static"
        .\vcpkg\vcpkg install openssl zlib qtbase qtsvg qttools

    - name: Boost
      run: |
        $boostVersion = "1.86.0"
        $boostUrl = "https://archives.boost.io/release/$boostVersion/source/boost_$(($boostVersion -replace '\.', '_')).zip"
        Invoke-WebRequest -Uri $boostUrl -OutFile boost.zip
        Expand-Archive -Path boost.zip -DestinationPath .
        Remove-Item -Path boost.zip
        echo "BOOST_ROOT=$env:GITHUB_WORKSPACE\boost_$(($boostVersion -replace '\.', '_'))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        cd $env:BOOST_ROOT
        .\bootstrap.bat
        .\b2 --prefix=.\stage --with-system --with-filesystem --with-thread --with-chrono --with-date_time --with-regex --with-atomic --with-random --with-iostreams variant=release link=static runtime-link=static address-model=64

    - name: Libtorrent
      run: |
        git clone --branch RC_1_2 https://github.com/arvidn/libtorrent.git
        cd libtorrent
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=.\install -DBOOST_ROOT="$env:BOOST_ROOT" -DBoost_USE_STATIC_LIBS=ON -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_FLAGS="/MT" -DCMAKE_C_FLAGS="/MT"
        cmake --build . --config Release
        cmake --install . --config Release
        echo "LIBTORRENT_ROOT=$env:GITHUB_WORKSPACE\libtorrent\build\install" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: qBittorrent
      run: |
        git clone --branch v5_0_x https://github.com/qbittorrent/qBittorrent.git
        cd qBittorrent
        mkdir build
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows-static -DQT6=OFF -DBOOST_ROOT="$env:BOOST_ROOT" -DLibtorrentRasterbar_ROOT="$env:LIBTORRENT_ROOT" -DBoost_USE_STATIC_LIBS=ON
        cmake --build . --config Release
