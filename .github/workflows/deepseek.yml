name: Build libtorrent and qBittorrent with Qt6 from source (Windows Static)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up vcpkg (for qBittorrent dependencies)
      id: vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        echo "VCPKG_ROOT=$env:GITHUB_WORKSPACE\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Install qBittorrent dependencies (x64-windows-static)
      run: |
        $env:VCPKG_DEFAULT_TRIPLET="x64-windows-static"
        .\vcpkg\vcpkg install openssl zlib

    - name: Download and extract Boost
      run: |
        $boostVersion = "1.86.0"
        $boostUrl = "https://archives.boost.io/release/$boostVersion/source/boost_$(($boostVersion -replace '\.', '_')).zip"
        Invoke-WebRequest -Uri $boostUrl -OutFile boost.zip
        Expand-Archive -Path boost.zip -DestinationPath .
        Remove-Item -Path boost.zip
        echo "BOOST_ROOT=$env:GITHUB_WORKSPACE\boost_$(($boostVersion -replace '\.', '_'))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Build Boost
      run: |
        cd $env:BOOST_ROOT
        .\bootstrap.bat
        .\b2 --prefix=.\stage --with-system --with-filesystem --with-thread --with-chrono --with-date_time --with-regex --with-atomic --with-random --with-iostreams variant=release link=static runtime-link=static address-model=64

    - name: Clone and build libtorrent
      run: |
        git clone https://github.com/arvidn/libtorrent.git
        cd libtorrent
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=.\install -DBOOST_ROOT="$env:BOOST_ROOT" -DBoost_USE_STATIC_LIBS=ON -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_FLAGS="/MT" -DCMAKE_C_FLAGS="/MT"
        cmake --build . --config Release
        cmake --install . --config Release
        echo "LIBTORRENT_ROOT=$env:GITHUB_WORKSPACE\libtorrent\build\install" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Download Qt6 source code
      run: |
        $qtVersion = "6.6.0"
        $qtUrl = "https://download.qt.io/official_releases/qt/$($qtVersion -replace '\.', '')/$qtVersion/single/qt-everywhere-src-$qtVersion.zip"
        Invoke-WebRequest -Uri $qtUrl -OutFile qt6.zip
        Expand-Archive -Path qt6.zip -DestinationPath .
        Remove-Item -Path qt6.zip
        echo "QT6_ROOT=$env:GITHUB_WORKSPACE\qt-everywhere-src-$qtVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Build Qt6
      run: |
        cd $env:QT6_ROOT
        mkdir build
        cd build
        cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=.\install -DFEATURE_static_runtime=ON -DFEATURE_static=ON -DQT_BUILD_EXAMPLES=OFF -DQT_BUILD_TESTS=OFF
        cmake --build . --parallel
        cmake --install .
        echo "QT6_INSTALL_DIR=$env:QT6_ROOT\build\install" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Clone qBittorrent repository
      run: |
        git clone https://github.com/qbittorrent/qBittorrent.git
        cd qBittorrent
        git submodule update --init --recursive

    - name: Build qBittorrent
      run: |
        cd qBittorrent
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DQT6=ON -DCMAKE_PREFIX_PATH="$env:QT6_INSTALL_DIR" -DBOOST_ROOT="$env:BOOST_ROOT" -DLibtorrentRasterbar_ROOT="$env:LIBTORRENT_ROOT" -DBoost_USE_STATIC_LIBS=ON
        cmake --build . --config Release

    - name: Upload qBittorrent.exe as artifact
      uses: actions/upload-artifact@v4
      with:
        name: qBittorrent
        path: qBittorrent/build/qbittorrent.exe
